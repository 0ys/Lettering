stages:
  - notify

# Merge Request 발생 시 Mattermost로 알림 전송
notify_mattermost:
  stage: notify
  script:
    - >
      if [ -n "$CI_MERGE_REQUEST_IID" ]; then 
        curl -X POST -H "Content-Type: application/json" \
          -d '{
            "text": "🔀 *새로운 Merge Request가 생성되었습니다!* 🎉\n
            **프로젝트:** `'$CI_PROJECT_NAME'`\n
            **작성자:** `'$GITLAB_USER_LOGIN'`\n
            **브랜치:** `'$CI_COMMIT_REF_NAME'`\n
            **MR 제목:** \"'${CI_MERGE_REQUEST_TITLE:-"제목 없음"}'\"\n
            [**Merge Request 보기**]('$CI_PROJECT_URL/-/merge_requests/$CI_MERGE_REQUEST_IID')"
          }' https://meeting.ssafy.com/hooks/9ecrs1m8ybbtfpa5dxsms8n4zo
      else
        echo "❌ MR 정보 없음"
      fi

# 이슈 발생 시 Mattermost로 알림 전송
notify_issue:
  stage: notify
  script:
    - >
      if [ -n "$CI_COMMIT_MESSAGE" ]; then 
        curl -X POST -H "Content-Type: application/json" \
          -d '{
            "text": "📌 *새로운 이슈가 생성되었습니다!* 📝\n
            **프로젝트:** `'$CI_PROJECT_NAME'`\n
            **작성자:** `'$GITLAB_USER_LOGIN'`\n
            **이슈 제목:** \"'${CI_COMMIT_MESSAGE:-"제목 없음"}'\"\n
            [**이슈 보기**]('$CI_PROJECT_URL/-/issues/$CI_JOB_ID')"
          }' https://meeting.ssafy.com/hooks/9ecrs1m8ybbtfpa5dxsms8n4zo
      else
        echo "❌ 이슈 정보 없음"
      fi

# 자동 테스트 및 빌드 단계 추가 (필요 시)
test:
  stage: notify
  script:
    - echo "✅ 테스트 진행 중..."
    - echo "테스트 성공!"

# Runner 태그 설정 (등록한 Runner의 태그에 맞게 수정)
tags:
  - docker
  - runner
  - gitlab
